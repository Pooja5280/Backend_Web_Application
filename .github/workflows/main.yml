name: MERN Stack CI/CD

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]

jobs:
  # JOB 1: Run Backend Unit Tests
  backend-test:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./backend

    services:
      mongo:
        image: mongo:latest
        ports:
          - 27017:27017

    steps:
    - uses: actions/checkout@v3
    
    - name: Use Node.js 20
      uses: actions/setup-node@v3
      with:
        node-version: '20'
        
    - name: Install Dependencies
      run: npm ci
      
    - name: Run Jest Tests
      run: npm test
      env:
        MONGO_URI: mongodb://localhost:27017/test_db
        JWT_SECRET: super_secret_test_key

  # JOB 2: Verify Docker Build (The Safety Net)
  docker-build:
    name: Verify Docker Build
    runs-on: ubuntu-latest
    needs: backend-test # Only runs if tests pass

    steps:
    - uses: actions/checkout@v3

    - name: Build Backend Docker Image
      run: docker build ./backend -t mern-backend

    - name: Build Frontend Docker Image
      run: docker build ./frontend -t mern-frontend
      
    - name: Verify Docker Compose Config
      run: docker compose config